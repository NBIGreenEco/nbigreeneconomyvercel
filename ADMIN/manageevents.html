<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="manage_events.title">Manage Events - Green Economy Toolkit</title>
    <script type="module" src="/ADMIN/scripts/adminAuthCheck.js"></script>
    <script type="module" src="/Master%20Page(Header%20and%20Footer)/MasterPage.js"></script>
    <script src="https://unpkg.com/i18next@22/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend@2.2.0/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@7.0.1/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="/Master%20Page(Header%20and%20Footer)/Trans.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/Master%20Page(Header%20and%20Footer)/MasterPage.css">
    <style>
        :root {
            --green-primary: #4eb5a6;
            --green-dark: #005d6a;
            --green-light: #b8e5e1;
            --green-accent: #7cc8bc;
            --light-bg: #f8fffe;
            --background: #ffffff;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --border: #e2e8f0;
            --muted-foreground: #64748b;
            --primary: #1e293b;
            --primary-foreground: #f8fafc;
            --secondary: #f1f5f9;
            --secondary-foreground: #1e293b;
            --radius: 1rem;
            --danger: #dc3545;
            --danger-dark: #c82333;
        }
        body {
            font-family: "Poppins", sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            overflow-x: hidden;
        }
        body.loading {
            visibility: hidden;
            opacity: 0;
        }
        body.loaded {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--green-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .main {
            padding-top: 5rem;
            min-height: 100vh;
            padding: 0 2rem;
        }
        .hero {
            position: relative;
            height: 400px;
            background-image: linear-gradient(rgba(0, 93, 106, 0.7), rgba(78, 181, 166, 0.7)),
                            url("https://images.pexels.com/photos/371917/pexels-photo-371917.jpeg");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
            border-radius: var(--radius);
            overflow: hidden;
        }
        .hero-content {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem 3rem;
            border-radius: var(--radius);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 1rem;
        }
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--green-dark);
            margin-bottom: 1rem;
        }
        .form-container {
            background: var(--card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            margin-bottom: 3rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .form-container button {
            flex: 0 0 auto;
        }
        .form-container form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .form-container label {
            font-weight: 500;
            color: var(--card-foreground);
            font-size: 1.1rem;
        }
        .form-container input,
        .form-container textarea {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-container input:focus,
        .form-container textarea:focus {
            outline: none;
            border-color: var(--green-primary);
            box-shadow: 0 0 0 3px rgba(78, 181, 166, 0.1);
        }
        .btn-primary {
            background: var(--green-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .btn-danger:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }
        .events-list {
            background: var(--card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .event-item:last-child {
            border-bottom: none;
        }
        .event-details {
            flex: 1;
        }
        .event-actions {
            display: flex;
            gap: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: var(--card);
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            border-radius: var(--radius);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            font-size: 1.8rem;
            color: var(--green-dark);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .modal-content label {
            font-weight: 500;
            color: var(--card-foreground);
            font-size: 1.1rem;
        }
        .modal-content input,
        .modal-content textarea {
            padding: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-content input:focus,
        .modal-content textarea:focus {
            border-color: var(--green-primary);
            box-shadow: 0 0 0 3px rgba(78, 181, 166, 0.1);
        }
        .modal-content textarea {
            resize: vertical;
            min-height: 100px;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted-foreground);
            transition: color 0.2s ease;
        }
        .modal-close:hover {
            color: var(--green-primary);
        }
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .alert-modal.show {
            display: flex;
            opacity: 1;
        }
        .alert-modal-content {
            background: var(--card);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        .alert-modal.show .alert-modal-content {
            transform: scale(1);
        }
        .alert-modal.success .alert-modal-content {
            border-left: 4px solid var(--green-primary);
        }
        .alert-modal.error .alert-modal-content {
            border-left: 4px solid var(--danger);
        }
        .alert-modal-content p {
            font-size: 1.1rem;
            color: var(--card-foreground);
            margin-bottom: 1.5rem;
        }
        .alert-modal-btn {
            background: var(--green-primary);
            color: white;
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .alert-modal.error .alert-modal-btn {
            background: var(--danger);
        }
        .alert-modal-btn:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
        }
        .alert-modal.error .alert-modal-btn:hover {
            background: var(--danger-dark);
        }
        .alert-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--muted-foreground);
            transition: color 0.2s ease;
        }
        .alert-modal-close:hover {
            color: var(--green-primary);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .hero {
                height: auto;
                min-height: 200px;
                border-radius: 0.5rem;
            }
            .hero-content {
                padding: 1rem;
                max-width: 100%;
            }
            .form-container,
            .events-list {
                padding: 1rem;
            }
            .modal-content,
            .alert-modal-content {
                padding: 1.5rem;
            }
            .form-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="loading">
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <green-economy-header></green-economy-header>
    <section class="hero">
        <div class="hero-content">
            <h1 data-i18n="manage_events.title">Manage Events</h1>
        </div>
    </section>
    <section class="main">
        <div class="form-container">
            <button class="btn-primary" id="add-event-btn" data-i18n="manage_events.add_button">Add New Event</button>
            <button class="btn-primary" id="back-to-dashboard" data-i18n="manage_events.back_button">Back to Dashboard</button>
            <button class="btn-danger" id="logout-btn" data-i18n="[html]manage_events.logout_button"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
        </div>
        <div class="events-list"></div>
    </section>
    <div class="modal" id="add-event-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 data-i18n="manage_events.add_modal_title">Add New Event</h2>
            <form id="add-event-form">
                <label for="event-title" data-i18n="manage_events.title_label">Event Title:</label>
                <input type="text" id="event-title" required data-i18n="[placeholder]manage_events.title_placeholder" placeholder="Enter event title">
                <label for="event-date" data-i18n="manage_events.date_label">Event Date (YYYY-MM-DD):</label>
                <input type="date" id="event-date" required data-i18n="[placeholder]manage_events.date_placeholder" placeholder="Select event date">
                <label for="event-details" data-i18n="manage_events.details_label">Event Details:</label>
                <textarea id="event-details" required data-i18n="[placeholder]manage_events.details_placeholder" placeholder="Enter event details"></textarea>
                <button type="submit" class="btn-primary" data-i18n="manage_events.add_submit">Add Event</button>
            </form>
        </div>
    </div>
    <div class="modal" id="edit-event-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 data-i18n="manage_events.edit_modal_title">Edit Event</h2>
            <form id="edit-event-form">
                <input type="hidden" id="edit-event-id">
                <label for="edit-event-title" data-i18n="manage_events.title_label">Event Title:</label>
                <input type="text" id="edit-event-title" required data-i18n="[placeholder]manage_events.title_placeholder" placeholder="Enter event title">
                <label for="edit-event-date" data-i18n="manage_events.date_label">Event Date (YYYY-MM-DD):</label>
                <input type="date" id="edit-event-date" required data-i18n="[placeholder]manage_events.date_placeholder" placeholder="Select event date">
                <label for="edit-event-details" data-i18n="manage_events.details_label">Event Details:</label>
                <textarea id="edit-event-details" required data-i18n="[placeholder]manage_events.details_placeholder" placeholder="Enter event details"></textarea>
                <button type="submit" class="btn-primary" data-i18n="manage_events.update_submit">Update Event</button>
            </form>
        </div>
    </div>
    <green-economy-footer></green-economy-footer>
    <script type="module">
import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { resetAdminSession } from '/ADMIN/scripts/adminAuthCheck.js';

const firebaseConfig = {
    apiKey: "AIzaSyCfa827mvCLf1ETts6B_DmCfb7owTohBxk",
    authDomain: "nbi-green-economy.firebaseapp.com",
    projectId: "nbi-green-economy",
    storageBucket: "nbi-green-economy.appspot.com",
    messagingSenderId: "53732340059",
    appId: "1:53732340059:web:3fb3f086c6662e1e9baa7e",
    measurementId: "G-37VRZ5CGE4"
};

// Initialize Firebase
let app, db, auth;
if (!getApps().length) {
    app = initializeApp(firebaseConfig);
} else {
    app = getApp();
}
db = getFirestore(app);
auth = getAuth(app);

// Initialize i18next
i18next
    .use(i18nextHttpBackend)
    .use(i18nextBrowserLanguageDetector)
    .init({
        fallbackLng: 'en',
        supportedLngs: ['en', 'zu', 'tn'],
        backend: {
            loadPath: '/locales/{{lng}}.json?v=' + new Date().getTime()
        },
        detection: {
            order: ['querystring', 'cookie', 'localStorage', 'navigator', 'htmlTag'],
            caches: ['localStorage', 'cookie']
        }
    }, (err, t) => {
        if (err) {
            console.error('i18next initialization error:', err);
            setTimeout(() => {
                i18next.loadResources((loadErr) => {
                    if (loadErr) {
                        console.error('Retry failed:', loadErr);
                        applyFallbackTranslations();
                    } else {
                        console.log('i18next retry successful, language:', i18next.language);
                        finalizeLoading();
                    }
                });
            }, 2000);
            return;
        }
        console.log('i18next initialized for manage_events.html at', new Date().toLocaleString('en-ZA'), ':', i18next.language);
        finalizeLoading();
    });

function applyFallbackTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(elem => {
        const key = elem.getAttribute('data-i18n');
        if (key.startsWith('[')) {
            const match = key.match(/\[(\w+)\](.+)/);
            if (match) {
                const [, attr, i18nKey] = match;
                const fallback = elem.getAttribute(attr) || 'Content not available';
                elem.setAttribute(attr, fallback);
            }
        } else {
            const fallback = elem.textContent.trim() || 'Content not available';
            elem.textContent = fallback;
        }
    });
    console.warn('Applied fallback translations');
    finalizeLoading();
}

function updateContent() {
    const missingKeys = [];
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        try {
            if (key.startsWith('[')) {
                const match = key.match(/\[(\w+)\](.+)/);
                if (match) {
                    const [, attr, translationKey] = match;
                    const translation = i18next.t(translationKey, { defaultValue: element.getAttribute(attr) || 'Content not available' });
                    if (translation === translationKey) missingKeys.push(translationKey);
                    element.setAttribute(attr, translation);
                }
            } else {
                const translation = i18next.t(key, { defaultValue: element.textContent.trim() || 'Content not available' });
                if (translation === key) missingKeys.push(key);
                element.textContent = translation;
            }
        } catch (error) {
            console.error(`Error translating key ${key}:`, error);
        }
    });
    if (missingKeys.length > 0) {
        console.warn('Missing translations:', missingKeys);
    }
}

function finalizeLoading() {
    i18next.loadResources(() => {
        updateContent();
        document.body.classList.remove('loading');
        document.body.classList.add('loaded');
        document.querySelector('.loading-overlay').style.display = 'none';
        console.log('Translations loaded, content displayed');
    });
}

i18next.on('languageChanged', () => {
    console.log('Language changed to:', i18next.language);
    updateContent();
    loadEvents();
});

i18next.on('loaded', () => {
    updateContent();
});

function validateDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    return regex.test(dateString) && !isNaN(new Date(dateString).getTime());
}

async function loadEvents() {
    try {
        const eventsList = document.querySelector('.events-list');
        if (!eventsList) {
            console.error('Events list container not found');
            showAlertModal(i18next.t('manage_events.alert_list_not_found', { defaultValue: 'Events list container not found' }), 'error');
            return;
        }
        eventsList.innerHTML = '<p data-i18n="manage_events.loading">Loading events...</p>';
        updateContent();
        const eventsSnapshot = await getDocs(collection(db, 'events'));
        eventsList.innerHTML = '';
        if (eventsSnapshot.empty) {
            eventsList.innerHTML = '<p data-i18n="manage_events.empty">No events found.</p>';
            updateContent();
            return;
        }
        eventsSnapshot.forEach(doc => {
            const event = doc.data();
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.dataset.id = doc.id;
            const formattedDate = event.date && validateDate(event.date) ? event.date : i18next.t('manage_events.no_date', { defaultValue: 'No Date' });
            eventItem.innerHTML = `
                <div class="event-details">
                    <h4>${event.title || i18next.t('manage_events.no_title', { defaultValue: 'No Title' })}</h4>
                    <p>${i18next.t('manage_events.event_date', { defaultValue: 'Date: {date}', date: formattedDate })}</p>
                    <p>${event.details || i18next.t('manage_events.no_details', { defaultValue: 'No Details' })}</p>
                </div>
                <div class="event-actions">
                    <button class="btn-primary" data-action="edit" data-i18n="manage_events.edit">Edit</button>
                    <button class="btn-danger" data-action="delete" data-i18n="manage_events.delete">Delete</button>
                </div>
            `;
            eventsList.appendChild(eventItem);
        });
        updateContent();
    } catch (error) {
        console.error('Error loading events:', error.code, error.message);
        showAlertModal(i18next.t('manage_events.alert_load_error', { defaultValue: 'Error loading events: {message}', message: error.message }), 'error');
    }
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    } else {
        console.error(`Modal with ID ${modalId} not found`);
        showAlertModal(i18next.t('manage_events.alert_modal_not_found', { defaultValue: 'Modal not found: {id}', id: modalId }), 'error');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }
}

function showAlertModal(message, type = 'success') {
    const existingModal = document.getElementById('alert-modal');
    if (existingModal) existingModal.remove();
    const modal = document.createElement('div');
    modal.id = 'alert-modal';
    modal.className = `alert-modal ${type}`;
    modal.innerHTML = `
        <div class="alert-modal-content">
            <span class="alert-modal-close">&times;</span>
            <p>${message}</p>
            <button class="alert-modal-btn">${i18next.t('manage_events.alert_ok', { defaultValue: 'OK' })}</button>
        </div>
    `;
    document.body.appendChild(modal);
    const closeBtn = modal.querySelector('.alert-modal-close');
    const okBtn = modal.querySelector('.alert-modal-btn');
    const closeAlert = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    };
    closeBtn.addEventListener('click', closeAlert);
    okBtn.addEventListener('click', closeAlert);
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

async function editEvent(id, user) {
    if (!user) {
        showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to edit events.' }), 'error');
        setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
        return;
    }
    try {
        const eventDoc = await getDoc(doc(db, 'events', id));
        if (!eventDoc.exists()) throw new Error('Event not found');
        const event = eventDoc.data();
        document.getElementById('edit-event-title').value = event.title || '';
        document.getElementById('edit-event-date').value = event.date && validateDate(event.date) ? event.date : '';
        document.getElementById('edit-event-details').value = event.details || '';
        document.getElementById('edit-event-id').value = id;
        showModal('edit-event-modal');
    } catch (error) {
        console.error('Error editing event:', error.code, error.message);
        showAlertModal(i18next.t('manage_events.alert_edit_error', { defaultValue: 'Error editing event: {message}', message: error.message }), 'error');
    }
}

async function deleteEvent(id, user) {
    if (!user) {
        showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to delete events.' }), 'error');
        setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
        return;
    }
    if (!confirm(i18next.t('manage_events.alert_delete_confirm', { defaultValue: 'Are you sure you want to delete this event?' }))) return;
    try {
        await deleteDoc(doc(db, 'events', id));
        await loadEvents();
        showAlertModal(i18next.t('manage_events.alert_delete_success', { defaultValue: 'Event deleted successfully.' }));
    } catch (error) {
        console.error('Error deleting event:', error.code, error.message);
        showAlertModal(i18next.t('manage_events.alert_delete_error', { defaultValue: 'Error deleting event: {message}', message: error.message }), 'error');
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('DEBUG: DOM fully loaded for manage_events.html at', new Date().toLocaleString('en-ZA'));
    console.log('DEBUG: Initial sessionStorage state - verified:', sessionStorage.getItem('verified'), 'sessionStart:', sessionStorage.getItem('sessionStart'));

    try {
       
        

        // Load events immediately if session is verified
        const isVerified = sessionStorage.getItem('verified') === 'true';
        if (isVerified) {
            await loadEvents();
        } else {
            console.log('DEBUG: No valid session, waiting for Firebase auth');
        }

        // Wait for Firebase Auth state
        onAuthStateChanged(auth, async (user) => {
            console.log('DEBUG: Firebase auth state checked, user:', user ? user.email : 'null');
            if (!user) {
                console.log('DEBUG: No user signed in, redirecting to VerifyCode.html');
                showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to access this page.' }), 'error');
                setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
                return;
            }

            // Only check admin status for sensitive operations
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(button.closest('.modal').id));
            });

            const eventsList = document.querySelector('.events-list');
            if (eventsList) {
                eventsList.addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;
                    const id = button.closest('.event-item').dataset.id;
                    if (action === 'edit') await editEvent(id, user);
                    else if (action === 'delete') await deleteEvent(id, user);
                });
            } else {
                console.error('Events list container not found');
                showAlertModal(i18next.t('manage_events.alert_list_not_found', { defaultValue: 'Events list container not found' }), 'error');
            }

            const addEventForm = document.getElementById('add-event-form');
            if (addEventForm) {
                addEventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!user) {
                        showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to add events.' }), 'error');
                        setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
                        return;
                    }
                    const title = document.getElementById('event-title').value.trim();
                    const date = document.getElementById('event-date').value;
                    const details = document.getElementById('event-details').value.trim();
                    if (!title || !date || !details) {
                        showAlertModal(i18next.t('manage_events.alert_fill_fields', { defaultValue: 'Please fill in all required fields.' }), 'error');
                        return;
                    }
                    if (!validateDate(date)) {
                        showAlertModal(i18next.t('manage_events.alert_invalid_date', { defaultValue: 'Please enter a valid date in YYYY-MM-DD format.' }), 'error');
                        return;
                    }
                    try {
                        await addDoc(collection(db, 'events'), {
                            title,
                            date,
                            details,
                            location: '',
                            timestamp: Timestamp.fromDate(new Date())
                        });
                        addEventForm.reset();
                        closeModal('add-event-modal');
                        await loadEvents();
                        showAlertModal(i18next.t('manage_events.alert_add_success', { defaultValue: 'Event added successfully.' }));
                    } catch (error) {
                        console.error('Error adding event:', error.code, error.message);
                        showAlertModal(i18next.t('manage_events.alert_add_error', { defaultValue: 'Error adding event: {message}', message: error.message }), 'error');
                    }
                });
            }

            const editEventForm = document.getElementById('edit-event-form');
            if (editEventForm) {
                editEventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!user) {
                        showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to update events.' }), 'error');
                        setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
                        return;
                    }
                    const id = document.getElementById('edit-event-id').value;
                    const title = document.getElementById('edit-event-title').value.trim();
                    const date = document.getElementById('edit-event-date').value;
                    const details = document.getElementById('edit-event-details').value.trim();
                    if (!title || !date || !details) {
                        showAlertModal(i18next.t('manage_events.alert_fill_fields', { defaultValue: 'Please fill in all required fields.' }), 'error');
                        return;
                    }
                    if (!validateDate(date)) {
                        showAlertModal(i18next.t('manage_events.alert_invalid_date', { defaultValue: 'Please enter a valid date in YYYY-MM-DD format.' }), 'error');
                        return;
                    }
                    try {
                        await updateDoc(doc(db, 'events', id), {
                            title,
                            date,
                            details,
                            location: '',
                            timestamp: Timestamp.fromDate(new Date())
                        });
                        closeModal('edit-event-modal');
                        await loadEvents();
                        showAlertModal(i18next.t('manage_events.alert_update_success', { defaultValue: 'Event updated successfully.' }));
                    } catch (error) {
                        console.error('Error updating event:', error.code, error.message);
                        showAlertModal(i18next.t('manage_events.alert_update_error', { defaultValue: 'Error updating event: {message}', message: error.message }), 'error');
                    }
                });
            }

            const addEventBtn = document.getElementById('add-event-btn');
            if (addEventBtn) {
                addEventBtn.addEventListener('click', async () => {
                    if (!user) {
                        showAlertModal(i18next.t('manage_events.alert_not_authenticated', { defaultValue: 'You must be logged in to add events.' }), 'error');
                        setTimeout(() => window.location.assign('/LandingPage/SignInAndSignUp/VerifyCode.html'), 2000);
                        return;
                    }
                    showModal('add-event-modal');
                });
            }

            const backToDashboardBtn = document.getElementById('back-to-dashboard');
            if (backToDashboardBtn) {
                backToDashboardBtn.addEventListener('click', () => {
                    console.log('DEBUG: Back to dashboard clicked, setting sessionStorage');
                    sessionStorage.setItem('verified', 'true');
                    sessionStorage.setItem('sessionStart', Date.now().toString());
                    console.log('DEBUG: sessionStorage set, verified:', sessionStorage.getItem('verified'), 'sessionStart:', sessionStorage.getItem('sessionStart'));
                    setTimeout(() => {
                        console.log('DEBUG: Navigating to /ADMIN/admin-dashboard.html');
                        window.location.assign('/ADMIN/admin-dashboard.html');
                    }, 100);
                });
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    console.log('DEBUG: Logout button clicked');
                    resetAdminSession();
                });
            }
        });
    } catch (error) {
        console.error('Error in DOMContentLoaded:', error.code, error.message);
        showAlertModal(i18next.t('manage_events.alert_load_error', { defaultValue: 'An error occurred while loading the page: {message}', message: error.message }), 'error');
        document.body.classList.remove('loading');
        document.body.classList.add('loaded');
        document.querySelector('.loading-overlay').style.display = 'none';
    }
});

// Fallback timeout
setTimeout(() => {
    if (document.body.classList.contains('loading')) {
        console.warn('Loading timeout reached, forcing content display');
        applyFallbackTranslations();
        document.body.classList.remove('loading');
        document.body.classList.add('loaded');
        document.querySelector('.loading-overlay').style.display = 'none';
        showAlertModal(i18next.t('manage_events.alert_timeout', { defaultValue: 'Page load timeout. Displaying default content.' }), 'error');
    }
}, 10000);
    </script>
</body>
</html>