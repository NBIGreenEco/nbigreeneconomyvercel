<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script src="/scripts/analytics.js" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="title">Green Economy Toolkit</title>

  <!-- Firebase Email Verification Redirect -->
  <script>
    // Intercept Firebase email verification links and redirect to VerifyEmail.html
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const oobCode = urlParams.get('oobCode');
      const continueUrl = urlParams.get('continueUrl');
      
      // If this is a Firebase email verification link, redirect to VerifyEmail.html
      if (mode === 'verifyEmail' && oobCode) {
        // Extract email from continueUrl if available
        let email = urlParams.get('email');
        if (!email && continueUrl) {
          const emailMatch = continueUrl.match(/email=([^&]+)/);
          if (emailMatch) {
            email = decodeURIComponent(emailMatch[1]);
          }
        }
        
        // Build the redirect URL - use absolute path from root
        let verifyUrl = '/LandingPage/VerifyEmail.html?oobCode=' + encodeURIComponent(oobCode);
        if (email) {
          verifyUrl += '&email=' + encodeURIComponent(email);
        }
        
        console.log('Firebase email verification detected on MasterPage, redirecting to:', verifyUrl);
        window.location.href = verifyUrl;
      }
    })();
  </script>

    <!-- Translation System (Unofficial Google Translate API) -->
    <script>
      let currentLanguage = 'en';

      // Translate a single piece of text
      async function translateText(text, targetLang) {
        const sourceLang = currentLanguage || 'en';
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          return data[0].map(seg => seg[0]).join('');
        } catch (e) {
          console.error('Translation error:', e);
          return text;
        }
      }

      // Translate the whole page (all text nodes)
      async function translatePage(targetLang) {
        const selector = document.getElementById('langSelect');
        if (!selector) return;
        
        const original = selector.dataset.original || selector.options[selector.selectedIndex].text;
        selector.dataset.original = original;

        const translating = targetLang === 'en' ? 'English' :
                            targetLang === 'zu' ? 'isiZulu' :
                            'Setswana';
        selector.options[selector.selectedIndex].text = `Translating to ${translating}…`;

        const walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode: node => {
              const p = node.parentNode;
              if (!p) return NodeFilter.FILTER_REJECT;
              const tag = p.tagName;
              if (tag === 'SCRIPT' || tag === 'STYLE' || tag === 'NOSCRIPT') return NodeFilter.FILTER_REJECT;
              return node.nodeValue.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
            }
          }
        );

        const nodes = [];
        let n;
        while (n = walker.nextNode()) nodes.push(n);

        const BATCH = 15;
        for (let i = 0; i < nodes.length; i += BATCH) {
          const batch = nodes.slice(i, i + BATCH);
          const promises = batch.map(node => translateText(node.nodeValue, targetLang));
          const results = await Promise.all(promises);
          batch.forEach((node, idx) => node.nodeValue = results[idx]);
        }

        selector.options[selector.selectedIndex].text = original;
        currentLanguage = targetLang;
      }    function onLangChange() {
      const lang = this.value;
      if (lang === 'en') {
        location.reload();
        return;
      }
      translatePage(lang).catch(err => {
        console.error(err);
        alert('Translation failed – check your internet connection.');
      });
    }
  </script>

  <!-- Core Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <script src="../scripts/enhancedsearch.js"></script>
  <script src="https://unpkg.com/i18next@22/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@2.2.0/i18nextHttpBackend.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@7.0.1/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="../Trans.js"></script>
  <script src="MasterPage.js" type="module"></script>
  <link rel="stylesheet" href="MasterPage.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- Language Selector Styles -->
  <style>
    /* Placeholder for future styles */
  </style>

  <!-- Bot Penguin Messenger Widget -->
  <script id="messenger-widget-b" src="https://cdn.botpenguin.com/website-bot.js" defer>6912ee821c29f29c0d7d6882,6912edf6e9437105db53226c,agent</script>
</head>
<body>
  <green-economy-header></green-economy-header>
  <main id="main-content" data-i18n="main.placeholder">Page content will be inserted here</main>
  <green-economy-footer></green-economy-footer>
</body>
</html>